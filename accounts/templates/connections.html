{% extends "base.html" %}
{% load static %}
{% block title %}Connections - {{ user.username }}{% endblock %}

{% block content %}
<section class="connections-container">
    <h2>Connections of {{ user.username }}</h2>

    <!-- Tabs -->
    <div class="tabs">
        <button class="tab-button active" data-tab="followers">Followers ({{ followers|length }})</button>
        <button class="tab-button" data-tab="following">Following ({{ following|length }})</button>
    </div>

    <!-- Followers List -->
<div id="followers" class="tab-content active">
    <ul class="followers-list">
        {% for f in followers %}
            <li>
                <img src="{{ f.user.profile.profile_image.url }}" alt="">
                <a href="{% url 'dashboard_profile' f.user.username %}">
                    <span>{{ f.user.username }}</span>
                </a>
                {% if f.user != request.user %}
                    {% if f.is_following %}
                        <a href="{% url 'unfollow_user' f.user.id %}" class="btn">Unfollow</a>
                    {% else %}
                        <a href="{% url 'follow_user' f.user.id %}" class="btn">Follow</a>
                    {% endif %}
                {% endif %}
            </li>
        {% empty %}
            <p class="empty">No followers yet.</p>
        {% endfor %}
    </ul>
</div>

<!-- Following List -->
<div id="following" class="tab-content">
    <ul class="followers-list">
        {% for f in following %}
            <li>
                <img src="{{ f.user.profile.profile_image.url }}" alt="">
                <a href="{% url 'dashboard_profile' f.user.username %}">
                    <span>{{ f.user.username }}</span>
                </a>
                {% if f.user != request.user %}
                    {% if f.is_following %}
                        <a href="{% url 'unfollow_user' f.user.id %}" class="btn">Unfollow</a>
                    {% else %}
                        <a href="{% url 'follow_user' f.user.id %}" class="btn">Follow</a>
                    {% endif %}
                {% endif %}
            </li>
        {% empty %}
            <p class="empty">Not following anyone yet.</p>
        {% endfor %}
    </ul>
</div>

</section>

<script>
    // TAB SWITCHING
    const tabButtons = document.querySelectorAll('.tab-button');
    const tabContents = document.querySelectorAll('.tab-content');

    tabButtons.forEach(btn => {
        btn.addEventListener('click', () => {
            tabButtons.forEach(b => b.classList.remove('active'));
            btn.classList.add('active');

            tabContents.forEach(tc => tc.classList.remove('active'));
            document.getElementById(btn.dataset.tab).classList.add('active');
        });
    });

    // FOLLOW / UNFOLLOW AJAX
    const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;

    function ajaxFollow(userId, action, button) {
        fetch(`/ajax/follow/${userId}/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrftoken,
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ action: action }),
        })
        .then(res => res.json())
        .then(data => {
            if(data.status === 'ok') {
                if(action === 'follow') {
                    button.textContent = 'Unfollow';
                    button.classList.add('following');
                    button.dataset.action = 'unfollow';
                } else {
                    button.textContent = 'Follow';
                    button.classList.remove('following');
                    button.dataset.action = 'follow';
                }
            }
        });
    }

    document.querySelectorAll('.follow-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            const userId = btn.dataset.userId;
            const action = btn.classList.contains('following') ? 'unfollow' : 'follow';
            ajaxFollow(userId, action, btn);
        });
    });
</script>
{% endblock %}
