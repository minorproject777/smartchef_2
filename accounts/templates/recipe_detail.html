{% extends "base.html" %}
{% load static %}
{% load humanize %}
{% block title %}{{ recipe.title }}{% endblock %}

{% block content %}
<div class="recipe-detail">

    <!-- Title & Author -->
    <h2 class="recipe-title">{{ recipe.title }}</h2>
    <a href="{% url 'dashboard_profile' recipe.user.username %}">
            <p class="recipe-author">By {{ recipe.user.username }}</p>
    </a>
    <!-- Media Section -->
<div class="media-section">
    {% if recipe.image %}
    <div class="media-box">
        <img src="{{ recipe.image.url }}" class="detail-img" alt="{{ recipe.title }}">
    </div>
    {% endif %}

    {% if recipe.video %}
    <div class="media-box">
        <video controls class="detail-video">
            <source src="{{ recipe.video.url }}" type="video/mp4">
        </video>
    </div>
    {% endif %}
</div>

<!-- Info & Ingredients Section -->
<div class="info-ingredients">

    <div class="info-box">
    {% if recipe.difficulty %}
        <p><span class="info-label">Difficulty :</span> <span class="info-value">{{ recipe.difficulty }}</span></p>
    {% endif %}

    {% if recipe.cuisine %}
        <p><span class="info-label">Cuisine :</span> <span class="info-value">{{ recipe.cuisine }}</span></p>
    {% endif %}

    {% if recipe.prep_time %}
        <p><span class="info-label">Prep Time :</span> <span class="info-value">{{ recipe.prep_time }}</span></p>
    {% endif %}

    {% if recipe.cook_time %}
        <p><span class="info-label">Cook Time :</span> <span class="info-value">{{ recipe.cook_time }}</span></p>
    {% endif %}
    </div>


    <div class="ingredients-box">
        {% if recipe.ingredients %}
        <h3>Ingredients:</h3>
        <ul>
            {% for ingredient in recipe.ingredients.splitlines %}
            <li>{{ ingredient }}</li>
            {% endfor %}
        </ul>
        {% endif %}
    </div>
    </div>


    <!-- Instructions -->
    {% if recipe.short_description %}
    <div class="recipe-description">
        <h3>Instructions:</h3>
        <ul>
            {% for step in recipe.short_description.splitlines %}
                <li>{{ step }}</li>
            {% endfor %}
        </ul>
    </div>
    {% endif %}

    <!-- Likes / Delete -->
    <div class="recipe-actions">
            <form method="POST" action="{% url 'like_recipe' recipe.id %}" class="like-form"> 
                {% csrf_token %} 
                <button type="submit"> 
                    {% if user in recipe.likes.all %}‚ù§Ô∏è{% else %}ü§ç{% endif %} {{ recipe.total_likes }} 
                </button> 
            </form>
 
            <div class="delete-actions">
            {% if user == recipe.user %}
            <form method="POST" action="{% url 'delete_recipe' recipe.id %}" 
                onsubmit="return confirm('Are you sure you want to delete this recipe?');">
                {% csrf_token %}
                <button type="submit" class="btn-delete-in">
                    <i class="far fa-trash-alt"></i> 
                </button>

            </form>

            {% endif %}   
            </div>

    </div>

    

    <!-- Comments Section -->
    <!-- Comments Section (visible to everyone) -->
    <div class="comments-section">

     {% if user == recipe.user %}
                <a href="{% url 'recipe_likes_list' recipe.id %}" class="likes-link">
                    Who liked my recipe?
                </a>
            {% endif %}
    <h3>Comments</h3>

    <div class="comments">
        {% for comment in recipe.comments.all %}
        <div class="comment-block">

            <!-- Comment content -->
            <p>
                <img src="{% if comment.user.profile.profile_image %}{{ comment.user.profile.profile_image.url }}{% else %}{% static 'images/default.jpg' %}{% endif %}" alt="" class="comment-pfp">


                <strong>{{ comment.user.username }}</strong><br>
                {{ comment.content }}
                <br></br>

                <!-- Reply button -->
                    <a href="#" class="reply-toggle"
                    onclick="document.getElementById('reply-{{ comment.id }}').style.display='block'; return false;">
                        <button type="submit">
                                    <i class="fa-solid fa-reply"></i> 
                        </button>
                    </a>
                <!-- Delete comment (allowed for comment owner OR recipe owner) -->
                {% if user == comment.user or user == recipe.user %}
                    <a class="delete-btn-comment"
                       href="{% url 'delete_comment' recipe.id comment.id %}"
                       onclick="return confirm('Delete this comment?');">
                        <button type="submit">
                            <i class="far fa-trash-alt"></i> 
                        </button>
                    </a>
                {% endif %}

                
            </p>

            
            <!-- Reply form -->
            <form id="reply-{{ comment.id }}" method="POST"
                  action="{% url 'add_reply' recipe.id comment.id %}"
                  class="reply-form" style="display:none;">
                {% csrf_token %}
                <input type="text" name="reply" placeholder="Write a reply..." required>
                <button type="submit">Reply</button>
            </form>

            <!-- Show replies -->
            {% for reply in comment.replies.all %}
                <div class="reply">
                    <img src="{% if reply.user.profile.profile_image %}{{ reply.user.profile.profile_image.url }}{% else %}{% static 'images/default.jpg' %}{% endif %}" alt="" class="comment-pfp">
                    <strong>{{ reply.user.username }} : </strong>
                    {{ reply.content }}
                    <br></br>
                    <!-- Delete reply (reply owner OR recipe owner) -->
                    {% if user == reply.user or user == recipe.user %}
                        <a class="delete-btn-comment"
                           href="{% url 'delete_reply' recipe.id reply.id %}"
                           onclick="return confirm('Delete this reply?');">
                            <button type="submit">
                                <i class="far fa-trash-alt"></i> 
                            </button>

                        </a>
                    {% endif %}
                </div>
            {% endfor %}

        </div>
        {% empty %}
            <p>No comments yet.</p>
        {% endfor %}
    </div>

    <!-- Everyone can comment (owner too) -->
    <form method="POST">
        {% csrf_token %}
        <input type="text" name="content" placeholder="Add a comment..." required>
        <button type="submit">Post</button>
    </form>

    </div>

</div>


{% endblock %}

