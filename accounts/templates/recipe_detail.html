{% extends "base.html" %}
{% block title %}{{ recipe.title }}{% endblock %}

{% block content %}
<div class="recipe-detail">

    <!-- Recipe Title -->
    <h2 class="recipe-title">{{ recipe.title }}</h2>
    <p class="recipe-author">By {{ recipe.user.username }}</p>

    <!-- IMAGE (optional) -->
    {% if recipe.image %}
        <img class="detail-img" src="{{ recipe.image.url }}" alt="{{ recipe.title }}">
    {% endif %}

    <!-- VIDEO (optional) -->
    {% if recipe.video %}
        <video controls class="detail-video">
            <source src="{{ recipe.video.url }}" type="video/mp4">
            Your browser does not support the video tag.
        </video>
    {% endif %}

    <!-- Recipe Info (Ingredients, Difficulty, Prep/Cook/Total Time) -->
    <div class="recipe-info">
        {% if recipe.ingredients %}
        <div class="info-section">
            <h3>Ingredients:</h3>
            <ul>
                {% for ingredient in recipe.ingredients.splitlines %}
                    <li>{{ ingredient }}</li>
                {% endfor %}
            </ul>
        </div>
        {% endif %}

        <div class="info-section">
            {% if recipe.difficulty %}<p><strong>Difficulty:</strong> {{ recipe.difficulty }}</p>{% endif %}
            {% if recipe.prep_time %}<p><strong>Prep Time:</strong> {{ recipe.prep_time }}</p>{% endif %}
            {% if recipe.cook_time %}<p><strong>Cook Time:</strong> {{ recipe.cook_time }}</p>{% endif %}
            {% if recipe.total_time %}<p><strong>Total Time:</strong> {{ recipe.total_time }}</p>{% endif %}
        </div>
    </div>

    <!-- Description -->
    <div class="recipe-description">
    <h3>Instructions:</h3>
    <ul>
        {% for instruction in recipe.short_description.splitlines %}
            <li>{{ instruction }}</li>
        {% endfor %}
    </ul>
    </div>


    <!-- Actions: Likes / Delete -->
<div class="recipe-actions">

    <!-- Like Button (everyone including owner can like/unlike if you want) -->
    <form method="POST" action="{% url 'like_recipe' recipe.id %}" class="like-form">
        {% csrf_token %}
        <button type="submit">
            {% if user in recipe.likes.all %}
                ‚ù§Ô∏è Unlike
            {% else %}
                ü§ç Like
            {% endif %}
            ({{ recipe.total_likes }})
        </button>
    </form>

    <!-- Delete button only for owner -->
    {% if user == recipe.user %}
    <form method="POST" action="{% url 'delete_recipe' recipe.id %}" 
          onsubmit="return confirm('Are you sure you want to delete this recipe?');">
        {% csrf_token %}
        <button type="submit" class="btn-delete">Delete Recipe</button>
    </form>
    {% endif %}

</div>

<!-- Comments Section (visible to everyone) -->
<!-- Comments Section (visible to everyone) -->
<div class="comments-section">
    <h3>Comments</h3>

    <div class="comments">
        {% for comment in recipe.comments.all %}
        <div class="comment-block">

            <!-- Comment content -->
            <p>
                <strong>{{ comment.user.username }}:</strong>
                {{ comment.content }}

                <!-- Delete comment (allowed for comment owner OR recipe owner) -->
                {% if user == comment.user or user == recipe.user %}
                    <a class="delete-btn"
                       href="{% url 'delete_comment' recipe.id comment.id %}"
                       onclick="return confirm('Delete this comment?');">
                        Delete
                    </a>
                {% endif %}
            </p>

            <!-- Reply button -->
            <a href="#" class="reply-toggle"
               onclick="document.getElementById('reply-{{ comment.id }}').style.display='block'; return false;">
                Reply
            </a>

            <!-- Reply form -->
            <form id="reply-{{ comment.id }}" method="POST"
                  action="{% url 'add_reply' recipe.id comment.id %}"
                  class="reply-form" style="display:none;">
                {% csrf_token %}
                <input type="text" name="reply" placeholder="Write a reply..." required>
                <button type="submit">Reply</button>
            </form>

            <!-- Show replies -->
            {% for reply in comment.replies.all %}
                <div class="reply">
                    <strong>{{ reply.user.username }} (reply):</strong>
                    {{ reply.content }}

                    <!-- Delete reply (reply owner OR recipe owner) -->
                    {% if user == reply.user or user == recipe.user %}
                        <a class="delete-btn"
                           href="{% url 'delete_reply' recipe.id reply.id %}"
                           onclick="return confirm('Delete this reply?');">
                            Delete
                        </a>
                    {% endif %}
                </div>
            {% endfor %}

        </div>
        {% empty %}
            <p>No comments yet.</p>
        {% endfor %}
    </div>

    <!-- Everyone can comment (owner too) -->
    <form method="POST">
        {% csrf_token %}
        <input type="text" name="content" placeholder="Add a comment..." required>
        <button type="submit">Post</button>
    </form>

</div>

{% endblock %}

